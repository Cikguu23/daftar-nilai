<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Nilai Kurikulum Merdeka - Kelas 4B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .header-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #1e40af;
            color: white;
            font-weight: 600;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:nth-child(odd) {
            background-color: #ffffff;
        }
        tr:hover {
            background-color: #e5e7eb;
        }
        .editable {
            padding: 8px;
            min-height: 30px;
            cursor: text;
        }
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #eff6ff;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #app-container.hidden, #loading-container.hidden {
            display: none;
        }
        @media print {
            .no-print {
                display: none;
            }
            body {
                background-color: white;
            }
            .container {
                max-width: 100%;
                padding: 0;
            }
            .shadow-lg {
                box-shadow: none !important;
            }
            th {
                position: static;
            }
            .table-container {
                overflow-x: visible;
            }
        }
    </style>
</head>
<body>
    <!-- Kontainer untuk pesan loading/error -->
    <div id="loading-container" class="flex items-center justify-center h-screen">
        <div class="text-center p-4 bg-white rounded-lg shadow-md max-w-sm">
            <p id="loading-title" class="text-xl font-semibold text-gray-800">Memuat Aplikasi...</p>
            <p id="loading-subtitle" class="text-gray-600 mt-2">Menghubungkan ke Firebase Anda...</p>
        </div>
    </div>

    <!-- Kontainer utama aplikasi, disembunyikan secara default -->
    <div id="app-container" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
            <div class="header-gradient text-white p-6 no-print">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h1 class="text-2xl md:text-3xl font-bold">Daftar Nilai Kurikulum Merdeka</h1>
                        <p class="text-lg">Tahun Pelajaran 2025 - 2026</p>
                    </div>
                    <div class="text-right">
                        <h2 class="text-xl font-semibold">SD Negeri 008 Purnama</h2>
                        <p class="text-lg">Kelas 4B</p>
                        <div id="statusIndicator" class="text-xs font-light mt-1 p-1 bg-white/20 rounded-full">Menyambungkan...</div>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 no-print">
                    <div class="w-full md:w-auto mb-4 md:mb-0">
                        <div class="flex items-center">
                            <label for="semester" class="mr-2 font-medium">Semester:</label>
                            <select id="semester" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="printBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center btn no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                            Cetak
                        </button>
                        <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center btn no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export Excel
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="gradeTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th rowspan="2" class="align-middle">No</th>
                                <th rowspan="2" class="align-middle" style="min-width: 200px; text-align: left;">Nama Siswa</th>
                                <th colspan="7">Pendidikan Pancasila</th>
                                <th colspan="7">Bahasa Indonesia</th>
                                <th colspan="7">Matematika</th>
                                <th colspan="7">IPAS</th>
                                <th colspan="7">Seni Rupa</th>
                                <th rowspan="2" class="align-middle">Rata-rata</th>
                            </tr>
                            <tr>
                                <!-- Sub-headers for each subject -->
                                <th>P1</th> <th>P2</th> <th>P3</th> <th>P4</th> <th>P5</th> <th>P6</th> <th>NA</th>
                                <th>P1</th> <th>P2</th> <th>P3</th> <th>P4</th> <th>P5</th> <th>P6</th> <th>NA</th>
                                <th>P1</th> <th>P2</th> <th>P3</th> <th>P4</th> <th>P5</th> <th>P6</th> <th>NA</th>
                                <th>P1</th> <th>P2</th> <th>P3</th> <th>P4</th> <th>P5</th> <th>P6</th> <th>NA</th>
                                <th>P1</th> <th>P2</th> <th>P3</th> <th>P4</th> <th>P5</th> <th>P6</th> <th>NA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data siswa akan diisi di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-8 flex justify-between items-start">
                    <div>
                        <p class="font-medium">Keterangan:</p>
                        <p>P1 - P6 = Penilaian Harian</p>
                        <p>NA = Nilai Akhir</p>
                    </div>
                    <div class="text-center">
                        <p>Purnama, <div id="currentDate" contenteditable="true" class="editable inline-block min-w-[150px]"></div></p>
                        <p class="mt-1">Wali Kelas 4B</p>
                        <div class="h-16"></div>
                        <p class="font-medium underline">JUNID, S.Pd</p>
                        <p>NIP. 19881123 202221 1 004</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import fungsi yang diperlukan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Elemen UI
        const loadingContainer = document.getElementById('loading-container');
        const appContainer = document.getElementById('app-container');
        const statusIndicator = document.getElementById('statusIndicator');

        // Fungsi untuk menampilkan UI utama
        function showApp() {
            loadingContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        // Fungsi untuk menampilkan pesan error
        function showError(title, subtitle) {
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-subtitle').textContent = subtitle;
            loadingContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        // Penangan error global untuk menangkap kesalahan tak terduga
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Kesalahan Global Tertangkap:", { message, source, lineno, colno, error });
            showError("Terjadi Kesalahan Tak Terduga", "Aplikasi tidak dapat dimuat. Silakan periksa konsol untuk detail.");
            return true;
        };

        // Fungsi utama untuk memulai aplikasi
        async function main() {
            try {
                // 1. Konfigurasi dan Inisialisasi Firebase
                // PENTING: Pastikan Otentikasi Anonim diaktifkan di Firebase Console Anda
                const firebaseConfig = {
                    apiKey: "AIzaSyDKGi9dPJb7LBc7W_Xzmlb9_cPtasfSzZc",
                    authDomain: "daftar-nilai-bcc32.firebaseapp.com",
                    projectId: "daftar-nilai-bcc32",
                    storageBucket: "daftar-nilai-bcc32.appspot.com",
                    messagingSenderId: "588240620397",
                    appId: "1:588240620397:web:67d2bdb0dfcd446ad72864"
                };
                
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                console.log("Firebase berhasil diinisialisasi dengan konfigurasi Anda.");

                // 2. Otentikasi Pengguna (Anonim)
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error("Otentikasi anonim gagal, pengguna tidak ditemukan.");
                }
                
                const userId = currentUser.uid;
                console.log("Otentikasi berhasil. User ID:", userId);
                statusIndicator.textContent = "Terhubung";
                statusIndicator.style.backgroundColor = '#22c55e';

                // 3. Setup dan Tampilkan Aplikasi
                setupApplication(db);
                showApp();

            } catch (error) {
                console.error("Gagal memulai aplikasi:", error);
                if (error.code === 'auth/configuration-not-found') {
                     showError(
                        "Aksi Diperlukan: Aktifkan Otentikasi Anonim", 
                        "Buka Firebase Console > Authentication > Sign-in method, dan aktifkan provider 'Anonymous'."
                    );
                } else {
                    showError("Gagal Terhubung ke Firebase", error.message);
                }
            }
        }

        function setupApplication(db) {
            const students = [
                "AFIF AWAL SAID", "AIDA D'MY TREE RAMADANI", "AINI INDAH PUTRI", "ANANDA DZAKIRA",
                "ARYA REVAL DYANSYAH", "ASHYFA MEYLANI", "AYUNA ADELIA LAILANI", "AMANDA ADRILIA",
                "AZKA IRVI ANANDA", "CHANDRA JUNDY PRATAMA", "DEBBY QEISYA ATHIYA", "AFANDHA FAJRUL IKHSAN",
                "HABIB AKBAR SAPUTRA", "IRSYAD AL BAIHAQI", "KHAIRUNISA AZZAHRA", "MEI KHUSNUL KHATIMAH",
                "MUHAMMAD ABYAN ANNAFIS", "MUHAMMAD ADITYA", "NISYA AMIRAH ZAHRA", "NUR FATHIYATURAHMA",
                "NUR KHUSNIA MU'MINA", "NUR SAKHIRA", "ABDIS PERMADI", "RASYID AKMAL AZKA",
                "RIFAYA ANANDA", "YUDHA ALVARO"
            ];

            const tableBody = document.querySelector('#gradeTable tbody');
            const semesterSelect = document.getElementById('semester');
            const dateElement = document.getElementById('currentDate');
            let unsubscribeListeners = [];

            function getCollectionPath(subpath = '') {
                return `gradebooks/Kelas4B/semester_${semesterSelect.value}` + (subpath ? `/${subpath}` : '');
            }

            function initializeTable() {
                tableBody.innerHTML = '';
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.dataset.rowIndex = index;
                    row.innerHTML = `<td>${index + 1}</td><td class="text-left font-medium">${student}</td>`;
                    let cells = '';
                    for (let subjectIndex = 0; subjectIndex < 5; subjectIndex++) {
                        for (let p = 1; p <= 6; p++) {
                            cells += `<td><div contenteditable="true" class="editable" data-subject="${subjectIndex}" data-type="p${p}"></div></td>`;
                        }
                        cells += `<td><div class="font-medium bg-blue-50" data-na="${subjectIndex}"></div></td>`;
                    }
                    cells += `<td class="font-medium bg-yellow-50" data-average></td>`;
                    row.innerHTML += cells;
                    tableBody.appendChild(row);
                });
                listenForData();
            }

            function listenForData() {
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                const collectionPath = getCollectionPath();
                const gradesCollectionRef = collection(db, collectionPath);

                const unsubGrades = onSnapshot(gradesCollectionRef, (snapshot) => {
                    snapshot.forEach(doc => {
                        if (doc.id === 'metadata') return;
                        const studentIndex = parseInt(doc.id.replace('student_', ''));
                        const studentData = doc.data();
                        const row = tableBody.querySelector(`[data-row-index="${studentIndex}"]`);
                        if (row && studentData.grades) {
                            Object.entries(studentData.grades).forEach(([key, value]) => {
                                const match = key.match(/s(\d+)_t(.+)/);
                                if (match) {
                                    const [_, subject, type] = match;
                                    const cell = row.querySelector(`[data-subject="${subject}"][data-type="${type}"]`);
                                    if (cell && cell.textContent !== value) {
                                        cell.textContent = value;
                                    }
                                }
                            });
                        }
                    });
                    recalculateAllGrades();
                }, (error) => {
                    console.error("Error saat mengambil data nilai:", error);
                    showError("Gagal membaca data dari database.", error.message);
                });
                unsubscribeListeners.push(unsubGrades);

                const metadataDocRef = doc(db, collectionPath, 'metadata');
                const unsubMeta = onSnapshot(metadataDocRef, (doc) => {
                    if (doc.exists() && doc.data().date) {
                        dateElement.textContent = doc.data().date;
                    } else {
                        dateElement.textContent = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                    }
                });
                unsubscribeListeners.push(unsubMeta);
            }
            
            function recalculateAllGrades() {
                students.forEach((_, index) => {
                    for (let j = 0; j < 5; j++) {
                        calculateFinalGrade(index, j);
                    }
                });
            }

            function calculateFinalGrade(rowIndex, subjectIndex) {
                const row = tableBody.rows[rowIndex];
                if (!row) return;
                const gradeInputs = row.querySelectorAll(`[data-subject="${subjectIndex}"][data-type^="p"]`);
                const grades = Array.from(gradeInputs)
                    .map(input => parseFloat(input.textContent))
                    .filter(value => !isNaN(value));
                
                const naCell = row.querySelector(`[data-na="${subjectIndex}"]`);
                if (grades.length > 0) {
                    const average = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
                    naCell.textContent = average.toFixed(1);
                } else {
                    naCell.textContent = '';
                }
                calculateOverallAverage(rowIndex);
            }

            function calculateOverallAverage(rowIndex) {
                const row = tableBody.rows[rowIndex];
                if (!row) return;
                const finalGradeCells = row.querySelectorAll('[data-na]');
                const finalGrades = Array.from(finalGradeCells)
                    .map(cell => parseFloat(cell.textContent))
                    .filter(value => !isNaN(value));

                const avgCell = row.querySelector('[data-average]');
                if (finalGrades.length > 0) {
                    const average = finalGrades.reduce((sum, grade) => sum + grade, 0) / finalGrades.length;
                    avgCell.textContent = average.toFixed(1);
                } else {
                    avgCell.textContent = '';
                }
            }

            async function saveStudentData(rowIndex) {
                const row = tableBody.rows[rowIndex];
                if (!row) return;
                const studentName = row.cells[1].textContent;
                const grades = {};
                row.querySelectorAll('.editable[data-subject]').forEach(cell => {
                    const key = `s${cell.dataset.subject}_t${cell.dataset.type}`;
                    if (cell.textContent.trim() !== '') {
                        grades[key] = cell.textContent.trim();
                    }
                });
                const docId = `student_${rowIndex}`;
                const docRef = doc(db, getCollectionPath(), docId);
                try {
                    await setDoc(docRef, { name: studentName, grades: grades }, { merge: true });
                } catch (error) {
                    console.error(`Gagal menyimpan data untuk siswa baris ${rowIndex}:`, error);
                }
            }
            
            async function saveDate(value) {
                const docRef = doc(db, getCollectionPath(), 'metadata');
                try {
                    await setDoc(docRef, { date: value }, { merge: true });
                } catch (error) {
                    console.error("Gagal menyimpan tanggal:", error);
                }
            }

            tableBody.addEventListener('blur', (e) => {
                const cell = e.target.closest('.editable[data-subject]');
                if (cell) {
                    const row = cell.closest('tr');
                    const rowIndex = parseInt(row.dataset.rowIndex);
                    saveStudentData(rowIndex);
                }
            }, true);
            
            dateElement.addEventListener('blur', (e) => saveDate(e.target.textContent));
            semesterSelect.addEventListener('change', initializeTable);
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            document.getElementById('exportBtn').addEventListener('click', function() {
                let tableHTML = document.getElementById('gradeTable').outerHTML;
                tableHTML = tableHTML.replace(/<div contenteditable="true"[^>]*>/g, '').replace(/<\/div/g, '');
                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Nilai_Kelas_4B_Semester_${semesterSelect.value}.xls`;
                link.click();
            });

            // Inisialisasi awal
            initializeTable();
        }

        // Menjalankan fungsi utama saat DOM siap
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
